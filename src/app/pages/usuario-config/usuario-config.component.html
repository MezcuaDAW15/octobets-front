<main class="font-poppins w-full">
  <ng-container *ngIf="!(logged$ | async); else contenidoVista">
    <section class="flex-1 flex flex-col items-center justify-center text-center

           text-white p-10 pt-20 md:pt-10 overflow-auto">
      <h2 class="text-5xl font-oswald mb-4 drop-shadow-lg">
        ¡Aún no has iniciado sesión!
      </h2>
      <p class="max-w-xl mb-8 text-lg">
        Necesitas una cuenta de OctoBets para acceder a esta sección.
      </p>

      <div class="flex gap-6">
        <button routerLink="/login" class="px-8 py-3 rounded-full bg-primary hover:bg-primary-dark
                     text-white font-semibold shadow-lg transition">
          Iniciar sesión
        </button>
        <button routerLink="/registro" class="px-8 py-3 rounded-full bg-white/20 border border-white
                     font-semibold hover:bg-white/30 transition shadow-lg">
          ¡Crear cuenta!
        </button>
      </div>
      <img src="/assets/images/triste.png" alt="Ilustración"
        class="w-32 md:w-40 mt-10 drop-shadow-2xl select-none pointer-events-none" />
    </section>
  </ng-container>

  <ng-template #contenidoVista>
    <!-- HEADER -->
    <header class="mb-8 flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4">
      <div>
        <h2 class="text-text-primary text-4xl font-oswald font-bold tracking-widest">
          AJUSTES DE USUARIO
        </h2>
        <p class="text-text-secondary">Actualiza tus datos y tu avatar.</p>
      </div>
      <button class="flex items-center justify-center gap-2 px-5 py-2.5 rounded-full
           bg-surface-light hover:bg-primary/20 text-primary font-semibold
           transition" routerLink="/cartera">
        <mat-icon class="" fontIcon="account_balance_wallet"></mat-icon>
        Cartera
      </button>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- AVATARES -->
      <section class="bg-surface-light rounded-2xl p-6 shadow-sm flex flex-col items-center">
        <h2 class="text-2xl font-semibold mb-4">Tu Avatar</h2>
        <div class="grid grid-cols-3 gap-4">
          <button *ngFor="let av of avatars" (click)="selectedAvatar = av"
            class="w-16 h-16 md:w-20 md:h-20 rounded-full overflow-hidden transition-shadow focus:outline-none"
            [ngClass]="selectedAvatar === av
            ? 'ring-4 ring-primary ring-offset-2'
            : 'hover:ring-2 hover:ring-primary/50'">
            <img src="/assets/images/avatars/{{ av }}" alt="Avatar {{ av }}" class="w-full h-full object-cover" />
          </button>
        </div>
        <p class="mt-4 text-sm text-text-secondary text-center">
          Elige uno de los avatares predefinidos.
        </p>
      </section>

      <!-- FORMULARIO -->
      <section class="lg:col-span-2 bg-surface-light rounded-2xl p-8 shadow-sm flex flex-col">
        <form [formGroup]="form" class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1">
          <!-- Nombre -->
          <div>
            <label class="block text-text-secondary mb-1">Nombre <span class="text-red-500">*</span></label>
            <input formControlName="nombre" type="text" placeholder="Tu nombre"
              class="w-full border border-border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary" />
            <p *ngIf="form.get('nombre')!.invalid && form.get('nombre')!.touched" class="text-red-600 text-sm mt-1">
              Nombre obligatorio.
            </p>
          </div>
          <!-- Apellidos -->
          <div>
            <label class="block text-text-secondary mb-1">Apellidos</label>
            <input formControlName="apellidos" type="text" placeholder="Tus apellidos"
              class="w-full border border-border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary" />
          </div>
          <!-- Email -->
          <div class="md:col-span-2">
            <label class="block text-text-secondary mb-1">Email <span class="text-red-500">*</span></label>
            <input formControlName="email" type="email" placeholder="ejemplo@correo.com"
              class="w-full border border-border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary" />
            <p *ngIf="form.get('email')!.invalid && form.get('email')!.touched" class="text-red-600 text-sm mt-1">
              Email obligatorio y válido.
            </p>
          </div>
          <!-- Usuario -->
          <div>
            <label class="block text-text-secondary mb-1">Usuario <span class="text-red-500">*</span></label>
            <input formControlName="username" type="text" placeholder="Nombre de usuario"
              class="w-full border border-border rounded-lg px-4 py-2 focus:ring-2 focus:ring-primary" />
            <p *ngIf="form.get('username')!.invalid && form.get('username')!.touched" class="text-red-600 text-sm mt-1">
              Usuario obligatorio.
            </p>
          </div>

        </form>

        <!-- Error general -->
        <p *ngIf="formError" class="mt-6 text-red-600 text-center">{{ formError }}</p>

        <div class="mt-6 flex flex-col sm:flex-row justify-between items-center gap-4">
          <!-- Botón Guardar -->
          <button (click)="guardar()" [disabled]="loading" class="flex items-center gap-2 px-6 py-2 rounded-full
           bg-primary hover:bg-primary-dark text-white font-semibold
           shadow-lg hover:shadow-xl transition duration-200 disabled:opacity-50">
            <mat-icon>save</mat-icon>
            {{ loading ? 'Guardando...' : 'Guardar cambios' }}
          </button>

          <!-- Botón Cambiar Contraseña -->
          <button (click)="openPasswordModal()" class="flex items-center gap-2 px-6 py-2 rounded-full
           bg-gradient-to-r from-blue-600 to-indigo-500 text-white font-semibold
           shadow-md hover:shadow-lg hover:brightness-105 transition duration-200">
            <mat-icon>lock</mat-icon>
            Cambiar contraseña
          </button>
        </div>
      </section>
    </div>

    <!-- MODAL CAMBIO CONTRASEÑA -->
    <div *ngIf="showPasswordModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
      <div class="bg-surface-light rounded-2xl p-6 w-full max-w-md shadow-lg">
        <h3 class="text-xl font-semibold mb-4">Cambiar contraseña</h3>
        <form [formGroup]="passwordForm" (ngSubmit)="confirmPassword()" class="space-y-4">
          <!-- Antigua -->
          <div>
            <label class="block mb-1 font-medium">Contraseña actual</label>
            <input formControlName="oldPassword" type="password" placeholder="Introduce tu contraseña actual"
              class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" />
            <p *ngIf="passwordForm.get('oldPassword')!.invalid && passwordForm.get('oldPassword')!.touched"
              class="text-red-600 text-sm mt-1">
              La contraseña actual es obligatoria.
            </p>
          </div>
          <!-- Nueva -->
          <div>
            <label class="block mb-1 font-medium">Nueva contraseña</label>
            <input formControlName="newPassword" type="password" placeholder="Mín. 6 caracteres y 1 número"
              class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" />
            <p *ngIf="passwordForm.get('newPassword')!.invalid && passwordForm.get('newPassword')!.touched"
              class="text-red-600 text-sm mt-1">
              Debe tener al menos 6 caracteres e incluir al menos un número.
            </p>
          </div>
          <!-- Nueva 2 -->
          <div>
            <label class="block mb-1 font-medium">Repetir nueva contraseña</label>
            <input formControlName="confirmPassword" type="password" placeholder="Repite tu nueva contraseña"
              class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500" />
            <p *ngIf="passwordForm.hasError('mismatch') && passwordForm.get('confirmPassword')!.touched"
              class="text-red-600 text-sm mt-1">
              Las contraseñas no coinciden.
            </p>
          </div>
          <!-- Botones -->
          <div class="flex justify-end gap-3 pt-4">
            <button type="button" (click)="cancelPassword()"
              class="px-4 py-2 rounded-lg bg-surface hover:bg-gray-300 transition">
              Cancelar
            </button>
            <button type="submit" [disabled]="passwordForm.invalid || loadingPassword"
              class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition disabled:opacity-50">
              {{ loadingPassword ? 'Cambiando...' : 'Confirmar' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </ng-template>
</main>